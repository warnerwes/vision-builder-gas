<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Admin</title>
    <style>
      body { font-family: Arial, sans-serif; padding: 12px; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      input, select, button, textarea { font-size: 14px; }
      textarea { width: 100%; height: 120px; }
      .small { font-size: 12px; color: #666; }
      table { width:100%; border-collapse: collapse; font-size: 13px; }
      th, td { border-top: 1px solid #eee; padding: 6px; text-align: left; }
      .btn { padding: 6px 10px; border: 1px solid #444; border-radius: 6px; background:#fff; cursor:pointer; }
      .btn.primary { background:#1a73e8; color:#fff; border-color:#1a73e8; }
      .banner { margin: 8px 0; padding: 8px 10px; border-radius: 6px; display:none; }
      .banner.ok { display:block; background:#e8f5e9; color:#0b8043; border:1px solid #a5d6a7; }
      .banner.err{ display:block; background:#fdecea; color:#b00020; border:1px solid #f5c6cb; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
      .tight td, .tight th { padding: 4px; }
    </style>
  </head>
  <body>
    <h2>Vision Builder â€” Admin</h2>

    <div id="banner" class="banner"></div>

    <div class="grid">
      <!-- Users -->
      <div class="card">
        <h3>Add User</h3>
        <div class="row">
          <input id="uEmail" placeholder="email">
          <input id="uName" placeholder="display name">
          <input id="uGrade" placeholder="grade (e.g., 7)">
          <select id="uRole">
            <option>STUDENT</option><option>TEACHER</option><option>ADMIN</option><option>PARENT</option>
          </select>
          <button class="btn primary" onclick="addUser()">Add</button>
        </div>
        <div class="small" id="uMsg"></div>

        <h4 style="margin-top:12px;">Bulk Add (CSV: <span class="mono">email,displayName,gradeLevel,role</span>)</h4>
        <textarea id="bulk"></textarea>
        <div class="row">
          <button class="btn" onclick="bulkAdd()">Bulk Add</button>
          <div class="small" id="bMsg"></div>
        </div>

        <h3 style="margin-top:16px;">Users</h3>
        <table class="tight" id="usersTbl">
          <thead>
            <tr><th>Name</th><th>Email</th><th>Grade</th><th>Role</th><th>ID</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>


<div class="card">
  <h3>Import from Google Classroom</h3>
  <div class="row">
    <button class="btn primary" onclick="loadCourses()">Load My Courses</button>
    <button class="btn" onclick="refreshCourses()">Refresh</button>
  </div>
  <table class="tight" id="gcTbl">
    <thead>
      <tr><th>Name</th><th>Section</th><th>Course ID</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="small" id="gcMsg"></div>
</div>

      <!-- Classes + Enroll + Codes -->
      <div class="card">
        <h3>Add Class</h3>
        <div class="row">
          <input id="cName" placeholder="Class name (e.g., VEX IQ Competitive)">
          <input id="cType" placeholder="Type (e.g., VEX_IQ_COMP)">
          <button class="btn primary" onclick="addClass()">Add</button>
        </div>
        <div class="small" id="cMsg"></div>

        <h3 style="margin-top:12px;">Classes</h3>
        <table class="tight" id="classesTbl">
          <thead>
            <tr><th>Name</th><th>Type</th><th>ID</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>

        <h3 style="margin-top:16px;">Enroll by Email</h3>
        <div class="row">
          <input id="eEmail" placeholder="student email">
          <select id="eClass"></select>
          <button class="btn" onclick="enroll()">Enroll</button>
        </div>
        <div class="small" id="eMsg"></div>

        <h3 style="margin-top:16px;">Generate Join Code</h3>
        <div class="row">
          <select id="jClass"></select>
          <input id="jMax" type="number" value="20" style="width:80px"> <span class="small">max uses</span>
          <input id="jDays" type="number" value="7" style="width:80px"> <span class="small">days valid</span>
          <button class="btn primary" onclick="genCode()">Generate</button>
        </div>
        <div class="small" id="jMsg"></div>

        <h4 style="margin-top:12px;">Active/Recent Codes</h4>
        <table id="codesTbl"><thead>
          <tr><th>Class</th><th>Code</th><th>Expires</th><th>Uses</th><th>Max</th><th>Active</th><th></th></tr>
        </thead><tbody></tbody></table>
      </div>
    </div>

    <script>
      let STATE = { classes: [], users: [], joinCodes: [] };

      google.script.run.withSuccessHandler(init).withFailureHandler(err).api_admin_bootstrap();

      function err(e){ showBanner('Error: ' + (e && e.message ? e.message : e), true); }

      function init(data){
        STATE = data;
        fillClassSelects();
        renderUsers();
        renderClasses();
        renderCodes();
        showBanner('Loaded admin data.', false);
      }

      function showBanner(msg, isErr){
        const b = document.getElementById('banner');
        b.className = 'banner ' + (isErr ? 'err' : 'ok');
        b.textContent = msg;
      }

      // ===== Users =====
      function renderUsers(){
        const tb = document.querySelector('#usersTbl tbody'); tb.innerHTML = '';
        STATE.users.forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input class="mono" data-f="displayName" data-id="${u.id}" value="${escapeHtml(u.displayName||'')}"></td>
            <td><input class="mono" data-f="email" data-id="${u.id}" value="${escapeHtml(u.email||'')}"></td>
            <td><input class="mono" data-f="gradeLevel" data-id="${u.id}" value="${escapeHtml(u.gradeLevel||'')}"></td>
            <td>
              <select data-f="role" data-id="${u.id}">
                ${['STUDENT','TEACHER','ADMIN','PARENT'].map(r => `<option ${u.role===r?'selected':''}>${r}</option>`).join('')}
              </select>
            </td>
            <td class="mono">${u.id}</td>
            <td>
              <button class="btn" onclick="saveUser('${u.id}')">Save</button>
              <button class="btn" onclick="delUser('${u.id}')">Delete</button>
            </td>
          `;
          tb.appendChild(tr);
        });
      }

      function saveUser(id){
        const row = findRowInputs('#usersTbl', id);
        const payload = {
          id,
          displayName: row.displayName.value.trim(),
          email: row.email.value.trim(),
          gradeLevel: row.gradeLevel.value.trim(),
          role: row.role.value
        };
        google.script.run.withSuccessHandler(res => {
          showBanner(res.message || 'User updated.', false);
          google.script.run.withSuccessHandler(init).api_admin_bootstrap();
        }).withFailureHandler(e => showBanner('Save failed: ' + e.message, true))
          .api_admin_updateUser(payload);
      }

      function delUser(id){
        if (!confirm('Delete user and related data?')) return;
        google.script.run.withSuccessHandler(res => {
          showBanner(res.message || 'User deleted.', false);
          google.script.run.withSuccessHandler(init).api_admin_bootstrap();
        }).withFailureHandler(e => showBanner('Delete failed: ' + e.message, true))
          .api_admin_deleteUser(id);
      }

      function addUser(){
        const payload = {
          email: byId('uEmail').value.trim(),
          displayName: byId('uName').value.trim(),
          gradeLevel: byId('uGrade').value.trim(),
          role: byId('uRole').value
        };
        google.script.run.withSuccessHandler(res => {
          byId('uMsg').textContent = res.message || 'Added.';
          showBanner(res.message || 'User added.', false);
          google.script.run.withSuccessHandler(init).api_admin_bootstrap();
        }).withFailureHandler(e => { byId('uMsg').textContent = 'Error: ' + e.message; showBanner('Add failed: ' + e.message, true); })
          .api_admin_addUser(payload);
      }

      function bulkAdd(){
        const lines = byId('bulk').value;
        google.script.run.withSuccessHandler(res => {
          byId('bMsg').textContent = res.message;
          showBanner(res.message, false);
          google.script.run.withSuccessHandler(init).api_admin_bootstrap();
        }).withFailureHandler(e => { byId('bMsg').textContent = 'Error: ' + e.message; showBanner('Bulk add failed: ' + e.message, true); })
          .api_admin_bulkAddUsers(lines);
      }

      // ===== Classes =====
      function renderClasses(){
        const tb = document.querySelector('#classesTbl tbody'); tb.innerHTML = '';
        STATE.classes.forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input class="mono" data-f="name" data-id="${c.id}" value="${escapeHtml(c.name||'')}"></td>
            <td><input class="mono" data-f="type" data-id="${c.id}" value="${escapeHtml(c.type||'')}"></td>
            <td class="mono">${c.id}</td>
            <td>
              <button class="btn" onclick="saveClass('${c.id}')">Save</button>
              <button class="btn" onclick="delClass('${c.id}')">Delete</button>
            </td>
          `;
          tb.appendChild(tr);
        });
      }

      function saveClass(id){
        const row = findRowInputs('#classesTbl', id);
        const payload = { id, name: row.name.value.trim(), type: row.type.value.trim() };
        google.script.run.withSuccessHandler(res => {
          showBanner(res.message || 'Class updated.', false);
          google.script.run.withSuccessHandler(init).api_admin_bootstrap();
        }).withFailureHandler(e => showBanner('Save failed: ' + e.message, true))
          .api_admin_updateClass(payload);
      }

      function delClass(id){
        if (!confirm('Delete class and related data (enrollments, teams, mappings)?')) return;
        google.script.run.withSuccessHandler(res => {
          showBanner(res.message || 'Class deleted.', false);
          google.script.run.withSuccessHandler(init).api_admin_bootstrap();
        }).withFailureHandler(e => showBanner('Delete failed: ' + e.message, true))
          .api_admin_deleteClass(id);
      }

      // ===== Enroll & Join Codes =====
      function enroll(){
        const payload = { email: byId('eEmail').value.trim(), classId: byId('eClass').value, roleInClass: 'STUDENT' };
        google.script.run.withSuccessHandler(res => {
          byId('eMsg').textContent = res.message || 'Enrolled.';
          showBanner(res.message || 'Enrolled.', false);
        }).withFailureHandler(e => { byId('eMsg').textContent = 'Error: ' + e.message; showBanner('Enroll failed: ' + e.message, true); })
          .api_admin_enrollEmailToClass(payload);
      }

      function genCode(){
        const payload = { classId: byId('jClass').value, maxUses: Number(byId('jMax').value||0), daysValid: Number(byId('jDays').value||0) };
        google.script.run.withSuccessHandler(res => {
          byId('jMsg').textContent = `Code: ${res.code}`;
          showBanner(res.message || 'Code generated.', false);
          google.script.run.withSuccessHandler((d)=>{ STATE.joinCodes=d; renderCodes(); })
            .api_admin_listJoinCodes('');
        }).withFailureHandler(e => { byId('jMsg').textContent = 'Error: ' + e.message; showBanner('Code gen failed: ' + e.message, true); })
          .api_admin_generateJoinCode(payload);
      }

      function renderCodes(){
        const tb = document.querySelector('#codesTbl tbody'); tb.innerHTML='';
        STATE.joinCodes.forEach(c => {
          const tr = document.createElement('tr');
          const cls = STATE.classes.find(x => x.id===c.classId);
          tr.innerHTML = `
            <td>${cls ? cls.name : c.classId}</td>
            <td><b>${c.code}</b></td>
            <td>${(c.expiresAt||'').toString().slice(0,19).replace('T',' ')}</td>
            <td>${c.uses||0}</td>
            <td>${c.maxUses||0}</td>
            <td>${String(c.active)}</td>
            <td>${String(c.active).toLowerCase()==='true' ? '<button class="btn" data-id="'+c.id+'">Close</button>' : ''}</td>
          `;
          tb.appendChild(tr);
        });
        tb.querySelectorAll('button[data-id]').forEach(btn => {
          btn.onclick = () => {
            const id = btn.getAttribute('data-id');
            google.script.run.withSuccessHandler(res => {
              showBanner(res.message || 'Code closed.', false);
              google.script.run.withSuccessHandler((d)=>{ STATE.joinCodes=d; renderCodes(); })
                .api_admin_listJoinCodes('');
            }).withFailureHandler(e => showBanner('Close failed: ' + e.message, true))
              .api_admin_closeJoinCode(id);
          };
        });
      }

      // ===== shared helpers =====
      function fillClassSelects(){
        ['eClass','jClass'].forEach(id => {
          const sel = document.getElementById(id); sel.innerHTML='';
          STATE.classes.forEach(c => {
            const opt = document.createElement('option'); opt.value=c.id; opt.textContent=`${c.name} (${c.type})`;
            sel.appendChild(opt);
          });
        });
      }

      function byId(id){ return document.getElementById(id); }

      function findRowInputs(tableSel, id){
        const inputs = document.querySelectorAll(`${tableSel} [data-id="${id}"]`);
        const out = {};
        inputs.forEach(inp => out[inp.getAttribute('data-f')] = inp);
        return out;
      }

      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      }


// ==== Google Classroom UI ====
function loadCourses(){
  byId('gcMsg').textContent = 'Loadingâ€¦';
  google.script.run
    .withSuccessHandler(res => {
      if (!res || !res.courses) { byId('gcMsg').textContent = 'No courses found.'; return; }
      STATE.gcCourses = res.courses;
      renderGc();
      byId('gcMsg').textContent = `Loaded ${res.courses.length} course(s).`;
      showBanner('Loaded Classroom courses.', false);
    })
    .withFailureHandler(e => { byId('gcMsg').textContent = 'Error: ' + e.message; showBanner('Classroom load failed: ' + e.message, true); })
    .api_gc_listCourses();
}
function refreshCourses(){ loadCourses(); }

function renderGc(){
  const tb = document.querySelector('#gcTbl tbody'); tb.innerHTML='';
  (STATE.gcCourses || []).forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(c.name||'')}</td>
      <td>${escapeHtml(c.section||'')}</td>
      <td class="mono">${c.id}</td>
      <td>
        <button class="btn" onclick="previewRoster('${c.id}')">Preview</button>
        <button class="btn primary" onclick="importCourse('${c.id}')">Import</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

function previewRoster(courseId){
  byId('gcMsg').textContent = 'Fetching rosterâ€¦';
  google.script.run
    .withSuccessHandler(res => {
      const s = res.counts || {students:0,teachers:0};
      byId('gcMsg').textContent = `Teachers: ${s.teachers}, Students: ${s.students}`;
      showBanner(`Roster â€” teachers: ${s.teachers}, students: ${s.students}`, false);
    })
    .withFailureHandler(e => { byId('gcMsg').textContent = 'Error: ' + e.message; showBanner('Roster preview failed: ' + e.message, true); })
    .api_gc_previewCourseRoster(courseId);
}


function importCourse(courseId){
  byId('gcMsg').textContent = 'Importingâ€¦ (this may take a few seconds for large rosters)';

  // Disable all import buttons briefly for safety UX
  document.querySelectorAll('#gcTbl button').forEach(b => b.disabled = true);

  google.script.run
    .withSuccessHandler(res => {
      // Show detailed report
      const r = (res && res.report) || {};
      const details = [
        res.message || 'Imported.',
        `Teachers: ${r.teacherCount ?? '-'}`,
        `Students: ${r.studentCount ?? '-'}`,
        `Users added: ${r.addedUsers ?? 0}`,
        `Enrollments added: ${r.addedEnroll ?? 0}`,
        r.skippedNoEmail ? `Skipped (no email): ${r.skippedNoEmail}` : null
      ].filter(Boolean).join(' | ');

      byId('gcMsg').textContent = details;
      showBanner(details, false);

      // Refresh state so new class + users show immediately
      google.script.run.withSuccessHandler(init).api_admin_bootstrap();
      // Re-enable buttons
      document.querySelectorAll('#gcTbl button').forEach(b => b.disabled = false);
    })
    .withFailureHandler(e => {
      const msg = 'Import failed: ' + (e && e.message ? e.message : e);
      byId('gcMsg').textContent = msg;
      showBanner(msg, true);
      document.querySelectorAll('#gcTbl button').forEach(b => b.disabled = false);
    })
    .api_gc_importCourse(courseId);
}

function showBanner(msg, isErr){
  const b = document.getElementById('banner');
  b.className = 'banner ' + (isErr ? 'err' : 'ok');
  const ts = new Date().toLocaleTimeString();
  b.textContent = `[${ts}] ${msg}`;
}



    </script>
  </body>
</html>
