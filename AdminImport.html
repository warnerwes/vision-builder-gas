<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <style>
    body { font:14px Arial, sans-serif; padding:14px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn { padding:6px 10px; border:1px solid #444; border-radius:6px; background:#fff; cursor:pointer; }
    .btn.primary { background:#1a73e8; color:#fff; border-color:#1a73e8; }
    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th,td { border-top:1px solid #eee; padding:6px; text-align:left; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
    #msg { margin-top:8px; color:#555; }
  </style>
</head>
<body>
  <h3>Import from Google Classroom</h3>
  <div class="row">
    <button class="btn primary" onclick="loadCourses()">Load My Courses</button>
    <button class="btn" onclick="loadCourses()">Refresh</button>
  </div>

  <table id="tbl"><thead>
    <tr><th>Name</th><th>Section</th><th>Course ID</th><th></th></tr>
  </thead><tbody></tbody></table>

  <div id="msg">—</div>

<script>
  let COURSES = [];
  function setMsg(s){ document.getElementById('msg').textContent = s; }

  function loadCourses(){
    setMsg('Loading…');
    google.script.run.withSuccessHandler(res=>{
      COURSES = (res && res.courses) || [];
      render();
      setMsg(`Loaded ${COURSES.length} course(s).`);
    }).withFailureHandler(e=> setMsg('Error: ' + (e.message||e))).api_gc_listCourses();
  }

  function render(){
    const tb = document.querySelector('#tbl tbody'); tb.innerHTML='';
    COURSES.forEach(c=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(c.name||'')}</td>
        <td>${esc(c.section||'')}</td>
        <td class="mono">${c.id}</td>
        <td>
          <button class="btn" onclick="preview('${c.id}')">Preview</button>
          <button class="btn primary" onclick="doImport('${c.id}')">Import</button>
        </td>`;
      tb.appendChild(tr);
    });
  }

  function preview(courseId){
    setMsg('Fetching roster…');
    google.script.run.withSuccessHandler(r=>{
      const s = r && r.counts || {students:0,teachers:0};
      setMsg(`Teachers: ${s.teachers} | Students: ${s.students}`);
    }).withFailureHandler(e=> setMsg('Error: ' + (e.message||e))).api_gc_previewCourseRoster(courseId);
  }

  function doImport(courseId){
    setMsg('Importing…');
    google.script.run.withSuccessHandler(res=>{
      const r = (res && res.report) || {};
      const msg = [
        res.message || 'Imported.',
        `Teachers: ${r.teacherCount ?? '-'}`,
        `Students: ${r.studentCount ?? '-'}`,
        `Users added: ${r.addedUsers ?? 0}`,
        `Enrollments added: ${r.addedEnroll ?? 0}`,
        r.skippedNoIdentifier ? `Skipped(no id): ${r.skippedNoIdentifier}` : null
      ].filter(Boolean).join(' | ');
      setMsg(msg);
    }).withFailureHandler(e=> setMsg('Import failed: ' + (e.message||e)))
      .api_gc_importCourse(courseId);
  }

  function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
</script>
</body>
</html>
